name: Test and coverage

on:
  push:
    branches:
      - master
  pull_request:

env:
  LANG: C.UTF-8

jobs:
  test:
    runs-on: ubuntu-latest
    container: ghcr.io/apertium/apertium-apy-cicd
    strategy:
      matrix:
        python-version:
          - 3.6.15
          - 3.7.12
          - 3.8.12
          - 3.9.9
          - 3.10.1
    env:
      PYENV_VERSION: ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v2

      # TODO: Move to Dockerfile
      - name: Install Pyenv
        run: wget -nv -O- https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash

      # TODO: Move to Dockerfile
      - name: Setup Pyenv
        run: |
          echo "PYENV_ROOT=$HOME/.pyenv" >> $GITHUB_ENV
          echo "$HOME/.pyenv/bin" >> $GITHUB_PATH
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH

      # TODO: Move to Dockerfile
      - name: Install Python dependencies
        run: apt install libssl-dev libffi-dev libsqlite3-dev

      - name: Cache Python installation
        uses: actions/cache@v2
        id: cache-python
        with:
          path: ${{ env.PYENV_ROOT }}/versions/${{ matrix.python-version }}
          key: ${{ runner.os }}-python${{ matrix.python-version }}
      - name: Install Python
        run: pyenv install ${{ matrix.python-version }}
        if: steps.cache-python.outputs.cache-hit != 'true'

      - name: Install Pipenv
        run: pip install pipenv
      - name: Cache Pip dependencies
        id: cache-pipenv
        uses: actions/cache@v2
        with:
          path: ~/.local/share/virtualenvs
          key: ${{ runner.os }}-python${{ matrix.python-version }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
      - name: Install Pip dependencies
        if: steps.cache-pipenv.outputs.cache-hit != 'true'
        run: pipenv install --dev

      - name: Setup
        run: pipenv run make

      - name: Test
        run: NONPAIRS=/tmp/languages pipenv run make test

      - name: Coveralls
        run: pipenv run coveralls --service=github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
